import{g as R,a as S,A as D,r as n,M as k,j as e,e as _}from"./index-Bip9qa62.js";import{g as T,u as L,c as E,d as A}from"./productService-DOR3hITx.js";import{P as $}from"./Pagination-DhZMZKxY.js";import{S as a}from"./sweetalert2.esm.all-BQxta0Da.js";import{P as z}from"./ProductCard-D3WV3ovx.js";const I=async p=>{const g=R(),c=new FormData;return c.append("file-to-upload",p),(await S.post(D.uploadImage,c,{headers:{"Content-Type":"multipart/form-data",Authorization:g}})).data},P={title:"",category:"",origin_price:0,price:0,unit:"",description:"",content:"",is_enabled:1,imageUrl:"",imagesUrl:[],salefrom:"",saleto:""},B=n.forwardRef(({onUpdate:p,onCreate:g},c)=>{const[t,u]=n.useState(P),[o,f]=n.useState(!1),[b,h]=n.useState(!1),y=n.useRef(null),j=n.useRef(null),v=n.useRef(null);n.useEffect(()=>{j.current=new k(y.current,{backdrop:"static"})},[]),n.useImperativeHandle(c,()=>({show:(r,i)=>{r==="create"?(u(P),f(!0)):(u({...i}),f(!1)),v.current&&(v.current.value=""),j.current.show()},hide:()=>{j.current.hide()}}));const m=r=>{const{name:i,value:l,type:N,checked:C}=r.target;u({...t,[i]:N==="checkbox"?C?1:0:l})},U=(r,i)=>{const l=[...t.imagesUrl];l[r]=i,u({...t,imagesUrl:l})},s=()=>{const r=[...t.imagesUrl||[],""];u({...t,imagesUrl:r})},d=()=>{const r=[...t.imagesUrl||[]];r.pop(),u({...t,imagesUrl:r})},x=r=>{if(!["image/jpeg","image/png"].includes(r.type))return a.fire({icon:"error",title:"格式錯誤",text:"僅限使用 jpg、jpeg 與 png 格式"}),!1;const l=3;return r.size/1024/1024>l?(a.fire({icon:"error",title:"檔案過大",text:`檔案大小限制為 ${l}MB 以下`}),!1):!0},w=async r=>{const i=r.target.files[0];if(i){if(!x(i)){r.target.value="";return}h(!0);try{const l=await I(i);l.success?(u({...t,imageUrl:l.imageUrl}),a.fire({icon:"success",title:"圖片上傳成功",showConfirmButton:!1,timer:1500})):a.fire({icon:"error",title:"圖片上傳失敗",text:l.message||"未知錯誤"})}catch(l){a.fire({icon:"error",title:"圖片上傳錯誤",text:l.message||"發生錯誤"})}finally{h(!1),r.target.value=""}}},F=async(r,i)=>{const l=i.target.files[0];if(l){if(!x(l)){i.target.value="";return}h(!0);try{const N=await I(l);if(N.success){const C=[...t.imagesUrl];C[r]=N.imageUrl,u({...t,imagesUrl:C}),a.fire({icon:"success",title:"圖片上傳成功",showConfirmButton:!1,timer:1500})}else a.fire({icon:"error",title:"圖片上傳失敗",text:N.message||"未知錯誤"})}catch(N){a.fire({icon:"error",title:"圖片上傳錯誤",text:N.message||"發生錯誤"})}finally{h(!1),i.target.value=""}}},M=()=>{if(!t.title?.trim()){a.fire({icon:"error",title:"欄位必填",text:"請填寫標題"});return}if(!t.category?.trim()){a.fire({icon:"error",title:"欄位必填",text:"請填寫分類"});return}if(!t.unit?.trim()){a.fire({icon:"error",title:"欄位必填",text:"請填寫單位"});return}if(!t.origin_price||t.origin_price<=0){a.fire({icon:"error",title:"欄位必填",text:"請填寫原價"});return}if(!t.price||t.price<=0){a.fire({icon:"error",title:"欄位必填",text:"請填寫售價"});return}if(!t.description?.trim()){a.fire({icon:"error",title:"欄位必填",text:"請填寫產品描述"});return}if(!t.content?.trim()){a.fire({icon:"error",title:"欄位必填",text:"請填寫說明內容"});return}if(!t.salefrom||!t.saleto){a.fire({icon:"error",title:"欄位必填",text:"請填寫販售日期起和販售日期迄"});return}if(new Date(t.salefrom)>new Date(t.saleto)){a.fire({icon:"error",title:"日期錯誤",text:"販售日期起不可以大於販售日期迄"});return}o?g(t):p(t)};return e.jsx("div",{id:"productModal",ref:y,className:"modal fade",tabIndex:"-1","aria-labelledby":"productModalLabel","aria-hidden":"true",children:e.jsx("div",{className:"modal-dialog modal-xl",children:e.jsxs("div",{className:"modal-content border-0",children:[e.jsxs("div",{className:"modal-header bg-dark text-white",children:[e.jsx("h5",{id:"productModalLabel",className:"modal-title",children:o?"新增產品":"編輯產品"}),e.jsx("button",{type:"button",className:"btn-close btn-close-white",onClick:()=>j.current.hide(),"aria-label":"Close"})]}),e.jsx("div",{className:"modal-body",children:e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-sm-4",children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"imageUrl",className:"form-label",children:"封面圖片"}),e.jsx("div",{className:"input-group mb-3",children:e.jsx("input",{name:"imageUrl",type:"text",className:"form-control",placeholder:"請輸入圖片連結",value:t.imageUrl,onChange:m})}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"fileInput",className:"form-label",children:"或 上傳圖片"}),e.jsx("input",{type:"file",className:"form-control",id:"fileInput",ref:v,onChange:w,disabled:b})]}),t.imageUrl&&e.jsx("img",{className:"img-fluid mt-3",src:t.imageUrl,alt:""})]}),e.jsx("h3",{className:"mb-3",children:"產品圖片"}),Array.isArray(t.imagesUrl)&&t.imagesUrl.map((r,i)=>e.jsxs("div",{className:"mb-3",children:[e.jsxs("label",{className:"form-label",children:["圖片網址 ",i+1]}),e.jsx("input",{type:"text",className:"form-control mb-2",placeholder:"請輸入圖片連結",value:r,onChange:l=>U(i,l.target.value)}),e.jsx("input",{type:"file",className:"form-control",onChange:l=>F(i,l),disabled:b}),r&&e.jsx("img",{className:"img-fluid mt-3 mb-3",src:r,alt:""})]},i)),e.jsxs("div",{className:"d-flex justify-content-between",children:[(!t.imagesUrl||t.imagesUrl.length===0||t.imagesUrl[t.imagesUrl.length-1])&&e.jsx("button",{className:"btn btn-outline-primary btn-sm w-100 me-2",onClick:s,children:"新增圖片"}),t.imagesUrl&&t.imagesUrl.length>0&&e.jsx("button",{className:"btn btn-outline-danger btn-sm w-100",onClick:d,children:"刪除圖片"})]})]}),e.jsxs("div",{className:"col-sm-8",children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"title",className:"form-label",children:"標題"}),e.jsx("input",{id:"title",name:"title",type:"text",className:"form-control",placeholder:"請輸入標題",value:t.title,onChange:m})]}),e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"mb-3 col-md-6",children:[e.jsx("label",{htmlFor:"category",className:"form-label",children:"分類"}),e.jsx("input",{id:"category",name:"category",type:"text",className:"form-control",placeholder:"請輸入分類",value:t.category,onChange:m})]}),e.jsxs("div",{className:"mb-3 col-md-6",children:[e.jsx("label",{htmlFor:"unit",className:"form-label",children:"單位"}),e.jsx("input",{id:"unit",name:"unit",type:"text",className:"form-control",placeholder:"請輸入單位",value:t.unit,onChange:m})]})]}),e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"mb-3 col-md-6",children:[e.jsx("label",{htmlFor:"origin_price",className:"form-label",children:"原價"}),e.jsx("input",{id:"origin_price",name:"origin_price",type:"number",className:"form-control",placeholder:"請輸入原價",min:"0",value:t.origin_price,onChange:m})]}),e.jsxs("div",{className:"mb-3 col-md-6",children:[e.jsx("label",{htmlFor:"price",className:"form-label",children:"售價"}),e.jsx("input",{id:"price",name:"price",type:"number",className:"form-control",placeholder:"請輸入售價",min:"0",value:t.price,onChange:m})]})]}),e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"mb-3 col-md-6",children:[e.jsx("label",{htmlFor:"salefrom",className:"form-label",children:"販售日期起(自訂欄位)"}),e.jsx("input",{id:"salefrom",name:"salefrom",type:"date",className:"form-control",value:t.salefrom||"",onChange:m})]}),e.jsxs("div",{className:"mb-3 col-md-6",children:[e.jsx("label",{htmlFor:"saleto",className:"form-label",children:"販售日期迄(自訂欄位)"}),e.jsx("input",{id:"saleto",name:"saleto",type:"date",className:"form-control",value:t.saleto||"",onChange:m})]})]}),e.jsx("hr",{}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"description",className:"form-label",children:"產品描述"}),e.jsx("textarea",{id:"description",name:"description",className:"form-control",placeholder:"請輸入產品描述",value:t.description,onChange:m,rows:10})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"content",className:"form-label",children:"說明內容"}),e.jsx("textarea",{id:"content",name:"content",className:"form-control",placeholder:"請輸入說明內容",value:t.content,onChange:m,rows:10})]}),e.jsx("div",{className:"row"}),e.jsx("div",{className:"mb-3",children:e.jsxs("div",{className:"form-check",children:[e.jsx("input",{id:"is_enabled",name:"is_enabled",className:"form-check-input",type:"checkbox",checked:!!t.is_enabled,onChange:m}),e.jsx("label",{className:"form-check-label",htmlFor:"is_enabled",children:"是否啟用"})]})})]})]})}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>j.current.hide(),children:"取消"}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:M,children:"確認"})]}),b&&e.jsx(_,{})]})})})}),H=n.forwardRef(({onDelete:p},g)=>{const[c,t]=n.useState(null),u=n.useRef(null),o=n.useRef(null);return n.useEffect(()=>{o.current=new k(u.current,{backdrop:"static"})},[]),n.useImperativeHandle(g,()=>({show:f=>{t(f),o.current.show()},hide:()=>{o.current.hide()}})),e.jsx("div",{id:"deleteModal",ref:u,className:"modal fade",tabIndex:"-1","aria-labelledby":"deleteModalLabel","aria-hidden":"true",children:e.jsx("div",{className:"modal-dialog",children:e.jsxs("div",{className:"modal-content border-0",children:[e.jsxs("div",{className:"modal-header bg-danger text-white",children:[e.jsx("h5",{id:"deleteModalLabel",className:"modal-title",children:e.jsx("span",{children:"刪除產品"})}),e.jsx("button",{type:"button",className:"btn-close btn-close-white",onClick:()=>o.current.hide(),"aria-label":"Close"})]}),e.jsxs("div",{className:"modal-body",children:["是否刪除 ",e.jsx("strong",{className:"text-danger",children:c?.title})," (刪除後將無法恢復)。"]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>o.current.hide(),children:"取消"}),e.jsx("button",{type:"button",className:"btn btn-danger",onClick:()=>p(c),children:"確認刪除"})]})]})})})}),J=()=>{const[p,g]=n.useState([]),[c,t]=n.useState({}),[u,o]=n.useState(!1),f=n.useRef(null),b=n.useRef(null);n.useEffect(()=>{h()},[]);const h=async(s=1,d=!0)=>{o(!0);try{const x=await T(s);g(x.products),g(x.products),t(x.pagination),d&&setTimeout(()=>{const w=document.querySelector(".container.mt-4");w&&w.scrollIntoView({behavior:"smooth",block:"start"})},0)}catch(x){a.fire({icon:"error",title:"取得產品失敗",text:x.response?.data?.message||"發生錯誤"})}finally{o(!1)}},y=async s=>{o(!0);try{const d={...s,origin_price:Number(s.origin_price),price:Number(s.price)};await E(d),f.current.hide(),await h(c.current_page,!1),a.fire({icon:"success",title:"新增成功"})}catch(d){a.fire({icon:"error",title:"新增失敗",text:d.response?.data?.message||"發生錯誤"})}finally{o(!1)}},j=async s=>{o(!0);try{const d={...s,origin_price:Number(s.origin_price),price:Number(s.price)};await L(s.id,d),f.current.hide(),await h(c.current_page,!1),a.fire({icon:"success",title:"更新成功"})}catch(d){a.fire({icon:"error",title:"更新失敗",text:d.response?.data?.message||"發生錯誤"})}finally{o(!1)}},v=async s=>{o(!0);try{await A(s.id),b.current.hide(),p.length===1&&c.current_page>1?await h(c.current_page-1,!1):await h(c.current_page,!1),a.fire({icon:"success",title:"刪除成功"})}catch(d){a.fire({icon:"error",title:"刪除失敗",text:d.response?.data?.message||"發生錯誤"})}finally{o(!1)}},m=(s,d)=>{f.current.show(s,d)},U=s=>{b.current.show(s)};return e.jsxs(e.Fragment,{children:[u&&e.jsx(_,{}),e.jsxs("div",{className:"container mt-4",children:[e.jsxs("div",{className:"d-flex justify-content-between mb-4",children:[e.jsx("h2",{children:"產品列表"}),e.jsx("div",{children:e.jsx("button",{className:"btn btn-primary me-2",onClick:()=>m("create"),children:"建立產品"})})]}),e.jsx("div",{className:"row mt-4",children:p.map(s=>e.jsx("div",{className:"col-md-6 mb-6",children:e.jsxs(z,{product:s,showStatus:!0,children:[e.jsx("button",{type:"button",className:"btn btn-outline-primary w-50 me-2",onClick:()=>m("edit",s),children:"編輯"}),e.jsx("button",{type:"button",className:"btn btn-outline-danger w-50",onClick:()=>U(s),children:"刪除"})]})},s.id))}),e.jsx($,{currentPage:c.current_page,totalPages:c.total_pages,onPageChange:h}),e.jsx(B,{ref:f,onCreate:y,onUpdate:j}),e.jsx(H,{ref:b,onDelete:v})]})]})};export{J as default};
