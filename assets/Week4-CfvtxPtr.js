import{g as R,a as S,A as D,r,M as I,j as e,e as P}from"./index-DihNd2Cw.js";import{g as L,u as T,c as $,d as E}from"./productService-C3c8pvJM.js";import{P as A}from"./Pagination-BHw7gLAo.js";import{S as o}from"./sweetalert2.esm.all-BQxta0Da.js";const U=async x=>{const b=R(),d=new FormData;return d.append("file-to-upload",x),(await S.post(D.uploadImage,d,{headers:{"Content-Type":"multipart/form-data",Authorization:b}})).data},k={title:"",category:"",origin_price:0,price:0,unit:"",description:"",content:"",is_enabled:1,imageUrl:"",imagesUrl:[],salefrom:"",saleto:""},B=r.forwardRef(({onUpdate:x,onCreate:b},d)=>{const[a,h]=r.useState(k),[c,f]=r.useState(!1),[g,u]=r.useState(!1),y=r.useRef(null),p=r.useRef(null),N=r.useRef(null);r.useEffect(()=>{p.current=new I(y.current,{backdrop:"static"})},[]),r.useImperativeHandle(d,()=>({show:(t,n)=>{t==="create"?(h(k),f(!0)):(h({...n}),f(!1)),N.current&&(N.current.value=""),p.current.show()},hide:()=>{p.current.hide()}}));const m=t=>{const{name:n,value:l,type:j,checked:v}=t.target;h({...a,[n]:j==="checkbox"?v?1:0:l})},w=(t,n)=>{const l=[...a.imagesUrl];l[t]=n,h({...a,imagesUrl:l})},s=()=>{const t=[...a.imagesUrl||[],""];h({...a,imagesUrl:t})},i=()=>{const t=[...a.imagesUrl||[]];t.pop(),h({...a,imagesUrl:t})},C=t=>{if(!["image/jpeg","image/png"].includes(t.type))return o.fire({icon:"error",title:"格式錯誤",text:"僅限使用 jpg、jpeg 與 png 格式"}),!1;const l=3;return t.size/1024/1024>l?(o.fire({icon:"error",title:"檔案過大",text:`檔案大小限制為 ${l}MB 以下`}),!1):!0},_=async t=>{const n=t.target.files[0];if(n){if(!C(n)){t.target.value="";return}u(!0);try{const l=await U(n);l.success?(h({...a,imageUrl:l.imageUrl}),o.fire({icon:"success",title:"圖片上傳成功",showConfirmButton:!1,timer:1500})):o.fire({icon:"error",title:"圖片上傳失敗",text:l.message||"未知錯誤"})}catch(l){o.fire({icon:"error",title:"圖片上傳錯誤",text:l.message||"發生錯誤"})}finally{u(!1),t.target.value=""}}},F=async(t,n)=>{const l=n.target.files[0];if(l){if(!C(l)){n.target.value="";return}u(!0);try{const j=await U(l);if(j.success){const v=[...a.imagesUrl];v[t]=j.imageUrl,h({...a,imagesUrl:v}),o.fire({icon:"success",title:"圖片上傳成功",showConfirmButton:!1,timer:1500})}else o.fire({icon:"error",title:"圖片上傳失敗",text:j.message||"未知錯誤"})}catch(j){o.fire({icon:"error",title:"圖片上傳錯誤",text:j.message||"發生錯誤"})}finally{u(!1),n.target.value=""}}},M=()=>{if(!a.salefrom||!a.saleto){o.fire({icon:"error",title:"欄位必填",text:"請填寫販售日期起和販售日期迄"});return}if(new Date(a.salefrom)>new Date(a.saleto)){o.fire({icon:"error",title:"日期錯誤",text:"販售日期起不可以大於販售日期迄"});return}c?b(a):x(a)};return e.jsx("div",{id:"productModal",ref:y,className:"modal fade",tabIndex:"-1","aria-labelledby":"productModalLabel","aria-hidden":"true",children:e.jsx("div",{className:"modal-dialog modal-xl",children:e.jsxs("div",{className:"modal-content border-0",children:[e.jsxs("div",{className:"modal-header bg-dark text-white",children:[e.jsx("h5",{id:"productModalLabel",className:"modal-title",children:c?"新增產品":"編輯產品"}),e.jsx("button",{type:"button",className:"btn-close btn-close-white",onClick:()=>p.current.hide(),"aria-label":"Close"})]}),e.jsx("div",{className:"modal-body",children:e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-sm-4",children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"imageUrl",className:"form-label",children:"封面圖片"}),e.jsx("div",{className:"input-group mb-3",children:e.jsx("input",{name:"imageUrl",type:"text",className:"form-control",placeholder:"請輸入圖片連結",value:a.imageUrl,onChange:m})}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"fileInput",className:"form-label",children:"或 上傳圖片"}),e.jsx("input",{type:"file",className:"form-control",id:"fileInput",ref:N,onChange:_,disabled:g})]}),a.imageUrl&&e.jsx("img",{className:"img-fluid mt-3",src:a.imageUrl,alt:""})]}),e.jsx("h3",{className:"mb-3",children:"產品圖片"}),Array.isArray(a.imagesUrl)&&a.imagesUrl.map((t,n)=>e.jsxs("div",{className:"mb-3",children:[e.jsxs("label",{className:"form-label",children:["圖片網址 ",n+1]}),e.jsx("input",{type:"text",className:"form-control mb-2",placeholder:"請輸入圖片連結",value:t,onChange:l=>w(n,l.target.value)}),e.jsx("input",{type:"file",className:"form-control",onChange:l=>F(n,l),disabled:g}),t&&e.jsx("img",{className:"img-fluid mt-3 mb-3",src:t,alt:""})]},n)),e.jsxs("div",{className:"d-flex justify-content-between",children:[(!a.imagesUrl||a.imagesUrl.length===0||a.imagesUrl[a.imagesUrl.length-1])&&e.jsx("button",{className:"btn btn-outline-primary btn-sm w-100 me-2",onClick:s,children:"新增圖片"}),a.imagesUrl&&a.imagesUrl.length>0&&e.jsx("button",{className:"btn btn-outline-danger btn-sm w-100",onClick:i,children:"刪除圖片"})]})]}),e.jsxs("div",{className:"col-sm-8",children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"title",className:"form-label",children:"標題"}),e.jsx("input",{id:"title",name:"title",type:"text",className:"form-control",placeholder:"請輸入標題",value:a.title,onChange:m})]}),e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"mb-3 col-md-6",children:[e.jsx("label",{htmlFor:"category",className:"form-label",children:"分類"}),e.jsx("input",{id:"category",name:"category",type:"text",className:"form-control",placeholder:"請輸入分類",value:a.category,onChange:m})]}),e.jsxs("div",{className:"mb-3 col-md-6",children:[e.jsx("label",{htmlFor:"unit",className:"form-label",children:"單位"}),e.jsx("input",{id:"unit",name:"unit",type:"text",className:"form-control",placeholder:"請輸入單位",value:a.unit,onChange:m})]})]}),e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"mb-3 col-md-6",children:[e.jsx("label",{htmlFor:"origin_price",className:"form-label",children:"原價"}),e.jsx("input",{id:"origin_price",name:"origin_price",type:"number",className:"form-control",placeholder:"請輸入原價",value:a.origin_price,onChange:m})]}),e.jsxs("div",{className:"mb-3 col-md-6",children:[e.jsx("label",{htmlFor:"price",className:"form-label",children:"售價"}),e.jsx("input",{id:"price",name:"price",type:"number",className:"form-control",placeholder:"請輸入售價",value:a.price,onChange:m})]})]}),e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"mb-3 col-md-6",children:[e.jsx("label",{htmlFor:"salefrom",className:"form-label",children:"販售日期起"}),e.jsx("input",{id:"salefrom",name:"salefrom",type:"date",className:"form-control",value:a.salefrom||"",onChange:m})]}),e.jsxs("div",{className:"mb-3 col-md-6",children:[e.jsx("label",{htmlFor:"saleto",className:"form-label",children:"販售日期迄"}),e.jsx("input",{id:"saleto",name:"saleto",type:"date",className:"form-control",value:a.saleto||"",onChange:m})]})]}),e.jsx("hr",{}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"description",className:"form-label",children:"產品描述"}),e.jsx("textarea",{id:"description",name:"description",className:"form-control",placeholder:"請輸入產品描述",value:a.description,onChange:m,rows:10})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"content",className:"form-label",children:"說明內容"}),e.jsx("textarea",{id:"content",name:"content",className:"form-control",placeholder:"請輸入說明內容",value:a.content,onChange:m,rows:10})]}),e.jsx("div",{className:"row"}),e.jsx("div",{className:"mb-3",children:e.jsxs("div",{className:"form-check",children:[e.jsx("input",{id:"is_enabled",name:"is_enabled",className:"form-check-input",type:"checkbox",checked:!!a.is_enabled,onChange:m}),e.jsx("label",{className:"form-check-label",htmlFor:"is_enabled",children:"是否啟用"})]})})]})]})}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>p.current.hide(),children:"取消"}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:M,children:"確認"})]}),g&&e.jsx(P,{})]})})})}),W=r.forwardRef(({onDelete:x},b)=>{const[d,a]=r.useState(null),h=r.useRef(null),c=r.useRef(null);return r.useEffect(()=>{c.current=new I(h.current,{backdrop:"static"})},[]),r.useImperativeHandle(b,()=>({show:f=>{a(f),c.current.show()},hide:()=>{c.current.hide()}})),e.jsx("div",{id:"deleteModal",ref:h,className:"modal fade",tabIndex:"-1","aria-labelledby":"deleteModalLabel","aria-hidden":"true",children:e.jsx("div",{className:"modal-dialog",children:e.jsxs("div",{className:"modal-content border-0",children:[e.jsxs("div",{className:"modal-header bg-danger text-white",children:[e.jsx("h5",{id:"deleteModalLabel",className:"modal-title",children:e.jsx("span",{children:"刪除產品"})}),e.jsx("button",{type:"button",className:"btn-close btn-close-white",onClick:()=>c.current.hide(),"aria-label":"Close"})]}),e.jsxs("div",{className:"modal-body",children:["是否刪除 ",e.jsx("strong",{className:"text-danger",children:d?.title})," (刪除後將無法恢復)。"]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>c.current.hide(),children:"取消"}),e.jsx("button",{type:"button",className:"btn btn-danger",onClick:()=>x(d),children:"確認刪除"})]})]})})})}),G=()=>{const[x,b]=r.useState([]),[d,a]=r.useState({}),[h,c]=r.useState(!1),f=r.useRef(null),g=r.useRef(null);r.useEffect(()=>{u()},[]);const u=async(s=1)=>{c(!0);try{const i=await L(s);b(i.products),a(i.pagination)}catch(i){o.fire({icon:"error",title:"取得產品失敗",text:i.response?.data?.message||"發生錯誤"})}finally{c(!1)}},y=async s=>{c(!0);try{const i={...s,origin_price:Number(s.origin_price),price:Number(s.price)};await $(i),f.current.hide(),await u(d.current_page),o.fire({icon:"success",title:"新增成功"})}catch(i){o.fire({icon:"error",title:"新增失敗",text:i.response?.data?.message||"發生錯誤"})}finally{c(!1)}},p=async s=>{c(!0);try{const i={...s,origin_price:Number(s.origin_price),price:Number(s.price)};await T(s.id,i),f.current.hide(),await u(d.current_page),o.fire({icon:"success",title:"更新成功"})}catch(i){o.fire({icon:"error",title:"更新失敗",text:i.response?.data?.message||"發生錯誤"})}finally{c(!1)}},N=async s=>{c(!0);try{await E(s.id),g.current.hide(),x.length===1&&d.current_page>1?await u(d.current_page-1):await u(d.current_page),o.fire({icon:"success",title:"刪除成功"})}catch(i){o.fire({icon:"error",title:"刪除失敗",text:i.response?.data?.message||"發生錯誤"})}finally{c(!1)}},m=(s,i)=>{f.current.show(s,i)},w=s=>{g.current.show(s)};return e.jsxs(e.Fragment,{children:[h&&e.jsx(P,{}),e.jsxs("div",{className:"container mt-4",children:[e.jsxs("div",{className:"d-flex justify-content-between mb-4",children:[e.jsx("h2",{children:"產品列表"}),e.jsx("div",{children:e.jsx("button",{className:"btn btn-primary me-2",onClick:()=>m("create"),children:"建立產品"})})]}),e.jsx("div",{className:"row mt-4",children:x.map(s=>e.jsx("div",{className:"col-md-6 mb-6",children:e.jsxs("div",{className:"card h-100 shadow-sm border-0",children:[e.jsxs("div",{className:"position-relative",style:{height:"250px",overflow:"hidden"},children:[s.imageUrl?e.jsx("img",{src:s.imageUrl,className:"card-img-top h-100 w-100",style:{objectFit:"cover"},alt:s.title}):e.jsx("div",{className:"h-100 w-100 bg-secondary d-flex align-items-center justify-content-center",children:e.jsx("span",{className:"text-white",children:"無圖片"})}),!s.is_enabled&&e.jsx("div",{className:"position-absolute top-0 start-0 w-100 h-100 bg-dark bg-opacity-50 d-flex align-items-center justify-content-center",children:e.jsx("span",{className:"text-white fw-bold border border-white px-3 py-1 rounded",children:"未啟用"})})]}),e.jsxs("div",{className:"card-body d-flex flex-column",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-start mb-2",children:[e.jsx("h5",{className:"card-title text-truncate mb-0",style:{maxWidth:"70%"},children:s.title}),e.jsx("span",{className:"badge bg-secondary",children:s.category})]}),e.jsx("p",{className:"card-text text-muted small mb-auto",style:{display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",overflow:"hidden"},children:s.description}),e.jsx("div",{className:"d-flex justify-content-between align-items-center mt-3",children:e.jsxs("div",{children:[s.origin_price!==s.price&&e.jsxs("small",{className:"text-decoration-line-through text-muted me-2",children:["$",s.origin_price]}),e.jsxs("span",{className:"fw-bold text-danger",children:["$",s.price]})]})})]}),e.jsxs("div",{className:"card-footer bg-transparent border-top-0 d-flex justify-content-between pb-3",children:[e.jsx("button",{type:"button",className:"btn btn-outline-primary w-50 me-2",onClick:()=>m("edit",s),children:"編輯"}),e.jsx("button",{type:"button",className:"btn btn-outline-danger w-50",onClick:()=>w(s),children:"刪除"})]})]})},s.id))}),e.jsx(A,{pageInfo:d,onPageChange:u}),e.jsx(B,{ref:f,onCreate:y,onUpdate:p}),e.jsx(W,{ref:g,onDelete:N})]})]})};export{G as default};
