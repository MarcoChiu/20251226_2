import{g as S,a as D,A as T,r as l,M as _,j as e,e as F}from"./index-RjUf2KTp.js";import{g as L,u as A,c as E,d as $}from"./productService-Dh1aZdxo.js";import{P as z}from"./Pagination-CV9d2gOv.js";import{a as y,s as o}from"./sweetAlert-BB8DS3-L.js";import{P as H}from"./ProductCard-DCrjLEz8.js";const P=async f=>{const g=S(),i=new FormData;return i.append("file-to-upload",f),(await D.post(T.uploadImage,i,{headers:{"Content-Type":"multipart/form-data",Authorization:g}})).data},k={title:"",category:"",origin_price:0,price:0,unit:"",description:"",content:"",is_enabled:1,imageUrl:"",imagesUrl:[],salefrom:"",saleto:""},q=l.forwardRef(({onUpdate:f,onCreate:g},i)=>{const[a,u]=l.useState(k),[c,p]=l.useState(!1),[b,h]=l.useState(!1),w=l.useRef(null),x=l.useRef(null),v=l.useRef(null);l.useEffect(()=>{x.current=new _(w.current,{backdrop:"static"})},[]),l.useImperativeHandle(i,()=>({show:(r,n)=>{r==="create"?(u(k),p(!0)):(u({...n}),p(!1)),v.current&&(v.current.value=""),x.current.show()},hide:()=>{x.current.hide()}}));const m=r=>{const{name:n,value:t,type:N,checked:U}=r.target;u({...a,[n]:N==="checkbox"?U?1:0:t})},I=(r,n)=>{const t=[...a.imagesUrl];t[r]=n,u({...a,imagesUrl:t})},s=()=>{const r=[...a.imagesUrl||[],""];u({...a,imagesUrl:r})},d=()=>{const r=[...a.imagesUrl||[]];r.pop(),u({...a,imagesUrl:r})},j=r=>{if(!["image/jpeg","image/png"].includes(r.type))return o("error","格式錯誤","僅限使用 jpg、jpeg 與 png 格式"),!1;const t=3;return r.size/1024/1024>t?(o("error","檔案過大",`檔案大小限制為 ${t}MB 以下`),!1):!0},C=async r=>{const n=r.target.files[0];if(n){if(!j(n)){r.target.value="";return}h(!0);try{const t=await P(n);t.success?(u({...a,imageUrl:t.imageUrl}),y("success","圖片上傳成功")):o("error","圖片上傳失敗",t.message||"未知錯誤")}catch(t){o("error","圖片上傳錯誤",t.message||"發生錯誤")}finally{h(!1),r.target.value=""}}},M=async(r,n)=>{const t=n.target.files[0];if(t){if(!j(t)){n.target.value="";return}h(!0);try{const N=await P(t);if(N.success){const U=[...a.imagesUrl];U[r]=N.imageUrl,u({...a,imagesUrl:U}),y("success","圖片上傳成功")}else o("error","圖片上傳失敗",N.message||"未知錯誤")}catch(N){o("error","圖片上傳錯誤",N.message||"發生錯誤")}finally{h(!1),n.target.value=""}}},R=()=>{if(!a.title?.trim()){o("error","欄位必填","請填寫標題");return}if(!a.category?.trim()){o("error","欄位必填","請填寫分類");return}if(!a.unit?.trim()){o("error","欄位必填","請填寫單位");return}if(!a.origin_price||a.origin_price<=0){o("error","欄位必填","請填寫原價");return}if(!a.price||a.price<=0){o("error","欄位必填","請填寫售價");return}if(!a.description?.trim()){o("error","欄位必填","請填寫產品描述");return}if(!a.content?.trim()){o("error","欄位必填","請填寫說明內容");return}if(!a.salefrom||!a.saleto){o("error","欄位必填","請填寫販售日期起和販售日期迄");return}if(new Date(a.salefrom)>new Date(a.saleto)){o("error","日期錯誤","販售日期起不可以大於販售日期迄");return}c?g(a):f(a)};return e.jsx("div",{id:"productModal",ref:w,className:"modal fade",tabIndex:"-1","aria-labelledby":"productModalLabel","aria-hidden":"true",children:e.jsx("div",{className:"modal-dialog modal-xl",children:e.jsxs("div",{className:"modal-content border-0",children:[e.jsxs("div",{className:"modal-header bg-dark text-white",children:[e.jsx("h5",{id:"productModalLabel",className:"modal-title",children:c?"新增產品":"編輯產品"}),e.jsx("button",{type:"button",className:"btn-close btn-close-white",onClick:()=>x.current.hide(),"aria-label":"Close"})]}),e.jsx("div",{className:"modal-body",children:e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-sm-4",children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"imageUrl",className:"form-label",children:"封面圖片"}),e.jsx("div",{className:"input-group mb-3",children:e.jsx("input",{name:"imageUrl",type:"text",className:"form-control",placeholder:"請輸入圖片連結",value:a.imageUrl,onChange:m})}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"fileInput",className:"form-label",children:"或 上傳圖片"}),e.jsx("input",{type:"file",className:"form-control",id:"fileInput",ref:v,onChange:C,disabled:b})]}),a.imageUrl&&e.jsx("img",{className:"img-fluid mt-3",src:a.imageUrl,alt:""})]}),e.jsx("h3",{className:"mb-3",children:"產品圖片"}),Array.isArray(a.imagesUrl)&&a.imagesUrl.map((r,n)=>e.jsxs("div",{className:"mb-3",children:[e.jsxs("label",{className:"form-label",children:["圖片網址 ",n+1]}),e.jsx("input",{type:"text",className:"form-control mb-2",placeholder:"請輸入圖片連結",value:r,onChange:t=>I(n,t.target.value)}),e.jsx("input",{type:"file",className:"form-control",onChange:t=>M(n,t),disabled:b}),r&&e.jsx("img",{className:"img-fluid mt-3 mb-3",src:r,alt:""})]},n)),e.jsxs("div",{className:"d-flex justify-content-between",children:[(!a.imagesUrl||a.imagesUrl.length===0||a.imagesUrl[a.imagesUrl.length-1])&&e.jsx("button",{className:"btn btn-outline-primary btn-sm w-100 me-2",onClick:s,children:"新增圖片"}),a.imagesUrl&&a.imagesUrl.length>0&&e.jsx("button",{className:"btn btn-outline-danger btn-sm w-100",onClick:d,children:"刪除圖片"})]})]}),e.jsxs("div",{className:"col-sm-8",children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"title",className:"form-label",children:"標題"}),e.jsx("input",{id:"title",name:"title",type:"text",className:"form-control",placeholder:"請輸入標題",value:a.title,onChange:m})]}),e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"mb-3 col-md-6",children:[e.jsx("label",{htmlFor:"category",className:"form-label",children:"分類"}),e.jsx("input",{id:"category",name:"category",type:"text",className:"form-control",placeholder:"請輸入分類",value:a.category,onChange:m})]}),e.jsxs("div",{className:"mb-3 col-md-6",children:[e.jsx("label",{htmlFor:"unit",className:"form-label",children:"單位"}),e.jsx("input",{id:"unit",name:"unit",type:"text",className:"form-control",placeholder:"請輸入單位",value:a.unit,onChange:m})]})]}),e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"mb-3 col-md-6",children:[e.jsx("label",{htmlFor:"origin_price",className:"form-label",children:"原價"}),e.jsx("input",{id:"origin_price",name:"origin_price",type:"number",className:"form-control",placeholder:"請輸入原價",min:"0",value:a.origin_price,onChange:m})]}),e.jsxs("div",{className:"mb-3 col-md-6",children:[e.jsx("label",{htmlFor:"price",className:"form-label",children:"售價"}),e.jsx("input",{id:"price",name:"price",type:"number",className:"form-control",placeholder:"請輸入售價",min:"0",value:a.price,onChange:m})]})]}),e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"mb-3 col-md-6",children:[e.jsx("label",{htmlFor:"salefrom",className:"form-label",children:"販售日期起(自訂欄位)"}),e.jsx("input",{id:"salefrom",name:"salefrom",type:"date",className:"form-control",value:a.salefrom||"",onChange:m})]}),e.jsxs("div",{className:"mb-3 col-md-6",children:[e.jsx("label",{htmlFor:"saleto",className:"form-label",children:"販售日期迄(自訂欄位)"}),e.jsx("input",{id:"saleto",name:"saleto",type:"date",className:"form-control",value:a.saleto||"",onChange:m})]})]}),e.jsx("hr",{}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"description",className:"form-label",children:"產品描述"}),e.jsx("textarea",{id:"description",name:"description",className:"form-control",placeholder:"請輸入產品描述",value:a.description,onChange:m,rows:10})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"content",className:"form-label",children:"說明內容"}),e.jsx("textarea",{id:"content",name:"content",className:"form-control",placeholder:"請輸入說明內容",value:a.content,onChange:m,rows:10})]}),e.jsx("div",{className:"row"}),e.jsx("div",{className:"mb-3",children:e.jsxs("div",{className:"form-check",children:[e.jsx("input",{id:"is_enabled",name:"is_enabled",className:"form-check-input",type:"checkbox",checked:!!a.is_enabled,onChange:m}),e.jsx("label",{className:"form-check-label",htmlFor:"is_enabled",children:"是否啟用"})]})})]})]})}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>x.current.hide(),children:"取消"}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:R,children:"確認"})]}),b&&e.jsx(F,{})]})})})}),B=l.forwardRef(({onDelete:f},g)=>{const[i,a]=l.useState(null),u=l.useRef(null),c=l.useRef(null);return l.useEffect(()=>{c.current=new _(u.current,{backdrop:"static"})},[]),l.useImperativeHandle(g,()=>({show:p=>{a(p),c.current.show()},hide:()=>{c.current.hide()}})),e.jsx("div",{id:"deleteModal",ref:u,className:"modal fade",tabIndex:"-1","aria-labelledby":"deleteModalLabel","aria-hidden":"true",children:e.jsx("div",{className:"modal-dialog",children:e.jsxs("div",{className:"modal-content border-0",children:[e.jsxs("div",{className:"modal-header bg-danger text-white",children:[e.jsx("h5",{id:"deleteModalLabel",className:"modal-title",children:e.jsx("span",{children:"刪除產品"})}),e.jsx("button",{type:"button",className:"btn-close btn-close-white",onClick:()=>c.current.hide(),"aria-label":"Close"})]}),e.jsxs("div",{className:"modal-body",children:["是否刪除 ",e.jsx("strong",{className:"text-danger",children:i?.title})," (刪除後將無法恢復)。"]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>c.current.hide(),children:"取消"}),e.jsx("button",{type:"button",className:"btn btn-danger",onClick:()=>f(i),children:"確認刪除"})]})]})})})}),K=()=>{const[f,g]=l.useState([]),[i,a]=l.useState({}),[u,c]=l.useState(!1),p=l.useRef(null),b=l.useRef(null);l.useEffect(()=>{h()},[]);const h=async(s=1,d=!0)=>{c(!0);try{const j=await L(s);g(j.products),a(j.pagination),d&&setTimeout(()=>{const C=document.querySelector(".container.mt-4");C&&C.scrollIntoView({behavior:"smooth",block:"start"})},0)}catch(j){o("error","取得產品失敗",j.response?.data?.message||"發生錯誤")}finally{c(!1)}},w=async s=>{c(!0);try{const d={...s,origin_price:Number(s.origin_price),price:Number(s.price)};await E(d),p.current.hide(),await h(i.current_page,!1),y("success","新增成功")}catch(d){o("error","新增失敗",d.response?.data?.message||"發生錯誤")}finally{c(!1)}},x=async s=>{c(!0);try{const d={...s,origin_price:Number(s.origin_price),price:Number(s.price)};await A(s.id,d),p.current.hide(),await h(i.current_page,!1),y("success","更新成功")}catch(d){o("error","更新失敗",d.response?.data?.message||"發生錯誤")}finally{c(!1)}},v=async s=>{c(!0);try{await $(s.id),b.current.hide(),f.length===1&&i.current_page>1?await h(i.current_page-1,!1):await h(i.current_page,!1),y("success","刪除成功")}catch(d){o("error","刪除失敗",d.response?.data?.message||"發生錯誤")}finally{c(!1)}},m=(s,d)=>{p.current.show(s,d)},I=s=>{b.current.show(s)};return e.jsxs(e.Fragment,{children:[u&&e.jsx(F,{}),e.jsxs("div",{className:"container mt-4",children:[e.jsxs("div",{className:"d-flex justify-content-between mb-4",children:[e.jsx("h2",{children:"產品列表"}),e.jsx("div",{children:e.jsx("button",{className:"btn btn-primary me-2",onClick:()=>m("create"),children:"建立產品"})})]}),e.jsx("div",{className:"row mt-4",children:f.map(s=>e.jsx("div",{className:"col-md-6 mb-6",children:e.jsxs(H,{product:s,showStatus:!0,children:[e.jsx("button",{type:"button",className:"btn btn-outline-primary w-50 me-2",onClick:()=>m("edit",s),children:"編輯"}),e.jsx("button",{type:"button",className:"btn btn-outline-danger w-50",onClick:()=>I(s),children:"刪除"})]})},s.id))}),e.jsx(z,{currentPage:i.current_page,totalPages:i.total_pages,onPageChange:h}),e.jsx(q,{ref:p,onCreate:w,onUpdate:x}),e.jsx(B,{ref:b,onDelete:v})]})]})};export{K as default};
